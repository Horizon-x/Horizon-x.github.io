<!DOCTYPE html><html lang="zh-CN"><head><link href="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.1.1/css/index.css" rel="stylesheet"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#0078E7"><meta name="author" content="ONESTONE"><meta name="copyright" content="ONESTONE"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>Java中保证线程安全的三板斧 | 上進心的小站</title><link rel="stylesheet" href="https://fonts.font.im/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal(){[".post-card",".post-content img"].forEach(e=>{ScrollReveal().reveal(e)})}document.addEventListener("DOMContentLoaded",initScrollReveal),document.addEventListener("pjax:success",initScrollReveal)</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded",()=>{Yun.utils.renderKatex()})</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme:light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme:dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><script id="yun-config">const Yun=window.Yun||{};window.CONFIG={hostname:"www.onexstone.online",root:"/",title:"上進心的小站",version:"1.6.2",mode:"auto",copycode:!0,page:{isPost:!0},i18n:{placeholder:"Search or jump to...",empty:"找不到您查询的内容: ${query}",hits:"找到 ${hits} 条结果",hits_time:"找到 ${hits} 条结果（用时 ${time} 毫秒）"},anonymous_image:"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg",say:{api:"https://v1.hitokoto.cn",hitokoto:!0},local_search:{path:"/search.xml"},fireworks:{colors:["102, 167, 221","62, 131, 225","33, 78, 194"]}}</script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="上進心的小站" type="application/atom+xml"><script src="/js/custom/change-site-title.js" defer></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><meta name="description" content="详细阐述Java中保证线程安全的三套策略"><meta property="og:type" content="article"><meta property="og:title" content="Java中保证线程安全的三板斧"><meta property="og:url" content="https://www.onexstone.online/posts/cf2f473d/index.html"><meta property="og:site_name" content="上進心的小站"><meta property="og:description" content="详细阐述Java中保证线程安全的三套策略"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-10-01T12:59:31.000Z"><meta property="article:modified_time" content="2021-10-15T12:10:20.493Z"><meta property="article:author" content="ONESTONE"><meta property="article:tag" content="JVM"><meta property="article:tag" content="Java"><meta property="article:tag" content="线程安全"><meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script><script src="/js/webpushr/webpushr-sw.js"></script><script src="/js/fancybox/jquery.min.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="ONESTONE"><img width="96" loading="lazy" src="https://cdn.jsdelivr.net/gh/horizon-x/imagesCDN/img/avatar-auther.png" alt="ONESTONE"><span class="site-author-status" title="永远相信美好的事情即将发生">😊</span></a><div class="site-author-name"><a href="/about/">ONESTONE</a></div><span class="site-name">上進心的小站</span><sub class="site-subtitle">Miracles happen every day.</sub><div class="site-desciption">既然选择了远方，便只顾风雨兼程</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><a class="site-state-item hty-icon-button" href="/shuoshuo/" title="TZone"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://z3.ax1x.com/2021/09/25/4sPUZF.png" title="QQ" target="_blank" style="color:#12b7f5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Horizon-x" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="http://music.163.com/m/user/home?id=107106147" title="网易云音乐" target="_blank" style="color:#c20c0c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://b23.tv/vfwGMM" title="bilibili" target="_blank" style="color:#ff8eb3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://my.oschina.net/onexstone" title="OSCHINA" target="_blank" style="color:#08c"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-fill"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://z3.ax1x.com/2021/09/24/4DSw9K.png" title="微信公众号" target="_blank" style="color:#1aad19"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-2-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:paoxbin@qq.com" title="E-Mail" target="_blank" style="color:#8e71c1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/albums/" title="Time Machine" style="color:#1e90ff"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-gallery-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color:#f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%9D%BF%E6%96%A7%E4%B9%8B%E4%B8%80%EF%BC%9A%E4%BA%92%E6%96%A5%E5%90%8C%E6%AD%A5"><span class="toc-number">2.</span> <span class="toc-text">三板斧之一：互斥同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#synchronized-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="toc-number">2.1.</span> <span class="toc-text">synchronized 关键字</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%9D%BF%E6%96%A7%E4%B9%8B%E4%BA%8C%EF%BC%9A%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%90%8C%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text">三板斧之二：非阻塞同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%9D%BF%E6%96%A7%E4%B9%8B%E4%B8%89%EF%BC%9A%E6%97%A0%E5%90%8C%E6%AD%A5%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-number">4.</span> <span class="toc-text">三板斧之三：无同步线程安全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">6.</span> <span class="toc-text">参考文献</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://www.onexstone.online/posts/cf2f473d/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="ONESTONE"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="上進心的小站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Java中保证线程安全的三板斧</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span><time title="创建时间：2021-10-01 20:59:31" itemprop="dateCreated datePublished" datetime="2021-10-01T20:59:31+08:00">2021-10-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span><time title="修改时间：2021-10-15 20:10:20" itemprop="dateModified" datetime="2021-10-15T20:10:20+08:00">2021-10-15</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span><span title="本文字数">3.2k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span><span title="阅读时长">12m</span></span></span><span class="leancloud_visitors" id="/posts/cf2f473d/" data-flag-title="Java中保证线程安全的三板斧"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="评论数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-chat-3-line"></use></svg> <span class="waline-comment-count" id="/posts/cf2f473d/"></span></span></a><div class="post-classify"><span class="post-category"><span class="post-meta-item-icon" style="margin-right:3px"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java并发编程</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/JVM/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">JVM</span></a><a class="tag-item" href="/tags/Java/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Java</span></a><a class="tag-item" href="/tags/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">线程安全</span></a></span></div><div class="post-author"><span class="author-name">ONESTONE</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>现在，如果要使用 Java 实现一段线程安全的代码，大致有 synchronized 、 java.util.concurrent 包等手段。虽然大家都会用，但却不一定真正清楚其在 JVM 层面上的实现原理，因此，笔者在查阅了一些资料后，希望把自己对此的一些见解分享给大家。</p><span id="more"></span><h3 id="三板斧之一：互斥同步"><a href="#三板斧之一：互斥同步" class="headerlink" title="三板斧之一：互斥同步"></a>三板斧之一：互斥同步</h3><ul><li>互斥同步：使用互斥的手段来保证同步操作。互斥是方法，同步是目的。</li><li>在 Java 的世界里，最基本的互斥同步手段就是使用 synchronized 关键字。</li></ul><h4 id="synchronized-关键字"><a href="#synchronized-关键字" class="headerlink" title="synchronized 关键字"></a>synchronized 关键字</h4><ol><li><p>synchronized 能实现同步的理论基础是：Java 中的每一个对象都可以作为锁。</p></li><li><p>synchronized 关键字在不同的使用场景下，作为锁的对象有所不同，主要分为以下三种情况：</p><ul><li>对于同步代码块，锁就是声明 synchronized 同步块时指定的对象（synchronized 括号中配置的对象）；</li><li>对于普通对象方法，锁就是当前的实例对象；</li><li>对于静态同步块，锁就是当前类的 Class 对象。</li></ul></li><li><p>我们可以通过一段代码来进一步说明 synchronized 是如何实现互斥同步的。</p></li></ol><ul><li><p>示例代码</p><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class SynchronizedTest &#123;
    public void test() &#123;
        synchronized (this) &#123;
            try &#123;
                System.out.println(&quot;SynchronizedTest.test() method start!&quot;);
            &#125; catch (Exception e) &#123;

            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对上述代码生成的字节码使用 Javap 进行反编译，结果如下：</p><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">Compiled from &quot;SynchronizedTest.java&quot;
public class com.xxx.JVMTest.SynchronizedTest &#123;
  public com.xxx.JVMTest.SynchronizedTest();
    Code:
       0: aload_0
       1: invokespecial #1                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V
       4: return

  public void test();
    Code:
       0: aload_0
       1: dup
       2: astore_1
       3: monitorenter
       4: getstatic     #2                  &#x2F;&#x2F; Field java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;PrintStream;
       7: ldc           #3                  &#x2F;&#x2F; String SynchronizedTest.test() method start!
       9: invokevirtual #4                  &#x2F;&#x2F; Method java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;lang&#x2F;String;)V
      12: aload_1
      13: monitorexit
      14: goto          22
      17: astore_2
      18: aload_1
      19: monitorexit
      20: aload_2
      21: athrow
      22: return
    Exception table:
       from    to  target type
           4    14    17   any
          17    20    17   any
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>我们可以看到反编译的代码中，存在两个由 Javac 编译器加入的指令，分别是插入到同步代码块开始位置的 monitorenter 指令和插入到同步代码块结束位置以及异常处的 monitorexit 指令。</p></li><li><p>根据《Java 虚拟机规范》可知，每个 Java 对象都有一个监视器锁（monitor）。在执行 monitorenter 指令时，首先要去尝试获取对象的锁，如果这个对象没被锁定，或者当前线程已经持有了该对象的锁，就把锁的计数器的值加一，而在执行 monitorexit 指令时会将锁计数器的值减一。一旦锁计数器的值为零，锁随即被释放。如果其他线程已经占用了该对象的锁，则该线程进入阻塞状态，直到锁的计数器为零时，再重新尝试获取该对象的所有权。</p></li><li><p>因此，<strong>本质上 JVM 就是通过进入 Monitor 对象（monitorenter）以及退出 Monitor 对象（monitorexit）来实现方法和代码块的同步操作。</strong></p></li></ul><ol><li>通过对 monitorenter 指令和 monitorexit 指令的分析，我们可以推出 synchronized 的三条结论：</li></ol><ul><li>被 synchronized 声明的同步代码块对同一线程而言是可重入的，所以同一线程重复进入同步块也不会出现被自己锁死的情况；</li><li>被 synchronized 声明的同步块在持有锁的线程执行完毕并释放锁之前，会无条件地阻塞后面其他线程的进入。因此无法实现对已经获得锁的线程强制释放锁的操作，以及对等待锁的线程实现中断等待或超时退出的机制。</li><li>由于 Java 线程是映射到操作系统的原生内核线程之上的，如果要阻塞或者唤醒一条线程，则需要操作系统来帮忙完成，这不可避免地陷入用户态到核心态的转变之中，因此在一些经典的 Java 并发编程资料中，synchronized 被形象地称为重量级锁。但它相对于利用 java.util.concurrent 包中 Lock 接口实现的锁机制仍有一个先天的优势，就是 synchronized 的锁信息是被 JVM 记录在线程和对象的元数据中的，可以很轻易的知道当前哪些锁对象是被哪些特定的线程所持有，从而更容易进行锁优化。</li></ul><ol start="5"><li>在这里需要补充一点的就是，同步方法虽然也可以使用 monitorenter 指令和 monitorexit 指令实现同步操作，但实际上目前的实现中并没有采用这种方案</li></ol><ul><li><p>我们可以具体分析下面的代码</p><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class SynchronizedTest &#123;
    public synchronized void testTwo() &#123;
        System.out.println(&quot;SynchronizedTest.testTwo() method start!&quot;);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>对上述代码生成的字节码使用 Javap 进行反编译，结果如下：</p><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public synchronized void testTwo();
  descriptor: ()V
  flags: ACC_PUBLIC, ACC_SYNCHRONIZED
  Code:
    stack&#x3D;2, locals&#x3D;1, args_size&#x3D;1
       0: getstatic     #2                  &#x2F;&#x2F; Field java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;PrintStream;
       3: ldc           #6                  &#x2F;&#x2F; String SynchronizedTest.testTwo() method start!
       5: invokevirtual #4                  &#x2F;&#x2F; Method java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;lang&#x2F;String;)V
       8: return
    LineNumberTable:
      line 23: 0
      line 24: 8
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       9     0  this   Lcom&#x2F;xxx&#x2F;JVMTest&#x2F;SynchronizedTest;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>从反编译的结果来看，方法的同步并没有通过指令 monitorenter 和 monitorexit 来完成。相对于普通方法，其常量池中多了 ACC_SYNCHRONIZED 标示符。实质上 JVM 是根据该标示符来实现方法的同步的，当方法被调用时，调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置，如果设置了，执行线程将先获取 Monitor 锁，获取成功之后才去执行方法体，并在方法执行完后释放 Monitor 锁。同时，在方法执行期间，其他任何线程都无法再获得同一个 Monitor 锁对象。</p></li><li><p>方法的同步和代码块的同步没有本质区别，只是其用一种隐式的方式来实现，无需通过字节码来完成。</p></li></ul><h3 id="三板斧之二：非阻塞同步"><a href="#三板斧之二：非阻塞同步" class="headerlink" title="三板斧之二：非阻塞同步"></a>三板斧之二：非阻塞同步</h3><ul><li>根据上一小节我们可以知道，在进行互斥同步时，无论共享的数据是否真的存在竞争，它都会进行加锁操作，从而导致用户态与核心态的转换、维护锁计数器以及检查是否有等待锁的线程需要被唤醒等额外开销，因此互斥同步属于一种悲观的并发策略。</li><li>那么是否存在一种乐观的并发策略呢？答案是有的，目前在 Java 中实现了一种基于冲突检测的加锁策略 ———— CAS 操作。</li><li>通俗的说就是先不管是否存在竞争，先进行操作，一旦产生了冲突，再通过其他补偿手段进行修正。最常见的就是通过不断地重试，直到没有竞争为止。</li><li>这种策略地好处在于全程是处于用户态中进行操作，从而避免了频繁地用户态与核心态之间的切换操作。</li></ul><ol><li>直到 JDK 5 ，在 java.util.concurrent.atomic 包中才提供了一些类支持原子级别的 CAS 操作，包括 AtomicBoolean、AtomicInteger、AtomicLong 等，而这些类的方法大多数又是调用的 sun.misc.Unsafe 类里面的 compareAndSwapInt() 和 compareAndSwapLong() 等几个保证原子操作的方法。</li></ol><ul><li><p>以 java.util.concurrent.atomic.AtomicInteger 类的 getAndIncrement() 方法为例：</p><pre class="line-numbers language-Java" data-language="Java"><code class="language-Java">public class AtomicInteger extends Number implements java.io.Serializable &#123;

    static &#123;
        try &#123;
            &#x2F;&#x2F;获取 value 变量的偏移量, 赋值给 valueOffset
            valueOffset &#x3D; unsafe.objectFieldOffset
                (AtomicInteger.class.getDeclaredField(&quot;value&quot;));
        &#125; catch (Exception ex) &#123; throw new Error(ex); &#125;
    &#125;

    &#x2F;**
     * Atomically increments by one the current value.
     *
     * @return the previous value
     *&#x2F;
    public final int getAndIncrement() &#123;
        return unsafe.getAndAddInt(this, valueOffset, 1);
    &#125;

    ...other methods...
&#125;

&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

public final class Unsafe &#123;
    public final int getAndAddInt(Object var1, long var2, int var4) &#123;
        int var5;
        do &#123;
            &#x2F;&#x2F;通过对象和偏移量获取变量的值
    	    &#x2F;&#x2F;由于 volatile 的修饰, 因此所有线程看到的 var5 都是一样的
            var5 &#x3D; this.getIntVolatile(var1, var2);
        &#125; while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

        return var5;
    &#125;

    ...other methods...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>我们可以看到 Unsafe 类的 getAndAddInt() 方法中存在一个 do while 循环，而循环条件中的 compareAndSwapInt() 方法会以原子的方式尝试修改 var5 的值。</p></li><li><p>具体而言，该方法通过 obj 和 valueOffset 获取变量的值，如果这个值和 var5 不一样，说明其他线程已经先一步修改了 obj + valueOffset 地址处的值，此时 compareAndSwapInt() 返回 false，继续循环；如果这个值和 var5 一样，说明没有其他线程修改 obj + valueOffset 地址处的值，此时可以将 obj + valueOffset 地址处的值改为 var5 + var4 ，compareAndSwapInt() 返回 true，退出循环。由于 compareAndSwapInt() 方法是原子操作, 所以compareAndSwapInt() 修改 obj + valueOffset 地址处的值时不会被其他线程中断。</p></li></ul><ol start="2"><li>通过上面的例子我们可以发现，使用 CAS 来实现同步操作也引发了一些新的问题：</li></ol><ul><li>如果自旋 CAS 长时间不成功，就会白白浪费本来就宝贵的 CPU 时间；</li><li>理论上而言，CAS 也只能保证一个共享变量的原子操作，功能上并没有 synchronized 同步代码块丰富；</li><li>ABA问题：我们可以假设这样一种场景，如果一个值原来是A，变成了B，之后又变回了A，那么在使用 CAS 操作进行检查时会出现以为它的值没有发生变化，而实际上已经变化了的情况。不过实际上即使出现了 ABA 问题在大部分并发情况下也不会影响程序的并发正确性，如果证实确实存在影响，那么最好改用 synchronized 同步代码块来实现同步操作。</li></ul><h3 id="三板斧之三：无同步线程安全"><a href="#三板斧之三：无同步线程安全" class="headerlink" title="三板斧之三：无同步线程安全"></a>三板斧之三：无同步线程安全</h3><ul><li>其实，同步与否与是否线程安全没有必然联系，同步只是实现线程安全的一种手段，如果存在有竞争的共享数据那么使用同步手段来保证线程安全也不失为一种好的方案，但如果本来就不存在竞争的可能，那它本身就有隐式的线程安全保证。</li></ul><ol><li><p>可重入代码（纯代码）</p><blockquote><p>是一种允许多个进程同时访问的代码。程序在运行过程中可以被打断，并由开始处再次执行，并且在合理的范围内（多次重入，而不造成堆栈溢出等其他问题），程序可以在被打断处继续执行，且执行结果不受影响。（<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%8F%AF%E9%87%8D%E5%85%A5%E4%BB%A3%E7%A0%81/1955592?fr=aladdin">可重入代码 | 百度百科</a>）</p></blockquote></li><li><p>可重入代码拥有一些共同的特征：</p></li></ol><ul><li>不依赖全局变量；</li><li>不依赖存储在堆上的数据和公用的系统资源；</li><li>使用到的状态量都由参数传入；</li><li>不调用其他非可重入的方法；<br>……</li></ul><ol start="3"><li><p>因此，如果一段代码中存在与其他代码的共享变量，只要能保证这些变量的可见范围只在同一个线程内，那么无需同步也能保证线程之间的数据安全性。</p></li><li><p>在 Java 中，使用了 java.lang.ThreadLocal 类来实现线程本地存储的功能，每个线程的 Thread 对象中都有一个 ThreadLocalMap 对象，这个对象存储了一组以 ThreadLocal.threadLocalHashCode 为键，以本地线程变量为值的 K - v 键值对。由于每个线程的 ThreadLocal.threadLocalHashCode 的值都是独一无二的，因此所映射的值也只能该线程自己才能访问到，也就实现了线程安全。</p></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol><li>可以使用互斥同步（阻塞同步）的方式，实现共享变量的线程安全，典型例子包括：synchronized 等;</li><li>可以使用自旋 CAS 的方式，实现共享变量的线程安全，典型例子包括：sun.misc.Unsafe 类、java.util.concurrent.atomic 包中的 AtomicBoolean、AtomicInteger、AtomicLong 等；</li><li>如果可以保证共享变量的可见范围均在同一个线程之内，那么其本身就带有隐式的线程安全性，不需要再做其他显式的同步操作。</li></ol><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ol><li>方腾飞, 魏鹏, 程晓明．Java并发编程的艺术 [M]. 北京：机械工业出版社，2015：11-20.</li><li>周志明．深入理解Java虚拟机: JVM高级特性与最佳实践（3 版）[M]. 北京：机械工业出版社，2019：471-478.</li></ol><blockquote><p>读书不觉已春深，一寸光阴一寸金。</p></blockquote></div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">你的支持就是我创作的最大的动力.</div><div id="qr" style="display:none"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://z3.ax1x.com/2021/09/25/4sPRde.jpg"><img loading="lazy" src="https://z3.ax1x.com/2021/09/25/4sPRde.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00a3ee"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://z3.ax1x.com/2021/09/25/4sPrxx.png"><img loading="lazy" src="https://z3.ax1x.com/2021/09/25/4sPrxx.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2dc100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>ONESTONE</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://www.onexstone.online/posts/cf2f473d/" title="Java中保证线程安全的三板斧">https://www.onexstone.online/posts/cf2f473d/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a>许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/posts/fa978b73/" rel="prev" title="HotSpot对synchronized的锁优化策略"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">HotSpot对synchronized的锁优化策略</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/e0afdf66/" rel="next" title="从零开始搭建一个属于自己的小站"><span class="post-nav-text">从零开始搭建一个属于自己的小站</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>要不要和我说些什么？</span><br></div><div id="waline"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js",()=>{const e={enable:!0,serverURL:"https://my-blogs-comment-system-gkgzbdn2n-horizon-x.vercel.app",visitor:!0,comment:!0,el:"#waline",lang:"zh-CN",path:"/posts/cf2f473d/",dark:'html[data-user-color-scheme="dark"]',emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-flag","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-weather","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/alus","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba"],avatar:"identicon"};new Waline(e)},window.Waline)</script></div><script src="/js/fancybox/jquery.fancybox.min.js"></script><script src="/js/fancybox/wrapImage.js"></script></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">京ICP备2021017712号</a></div><div class="copyright"><span>&copy; 2021 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="http://onexstone.online" title="about me"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></a><span class="author">ONESTONE</span><spen>|</spen><script>function blog_cnzz_analytics(){document.write(unescape("%3Cspan id='cnzz_stat_icon_1280383522'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1280383522' type='text/javascript'%3E%3C/script%3E"))}blog_cnzz_analytics()</script></div><div class="live_time"><span>本小站已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time(){setTimeout(blog_live_time,1e3);const e=new Date("2021-09-24T00:00:00"),t=new Date;var i=t.getTime()-e.getTime(),o=Math.floor(i/864e5),l=Math.floor(i%864e5/60/60/1e3),a=Math.floor(i%36e5/60/1e3),i=Math.floor(i%6e4/1e3);display_live_time.innerHTML=" "+o+" 天 "+l+" 小时 "+a+" 分 "+i+" 秒"}blog_live_time()</script></div><div class="footer-custom-text">Hosted by <a href="https://github.com/Horizon-x/Horizon-x.github.io" rel="noopener" target="_blank">GitHub Pages</a> & <a href="https://coding.net" rel="noopener" target="_blank">Coding Pages</a></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded",()=>{document.querySelector(".popup-trigger").addEventListener("click",()=>{document.querySelector(".popup").classList.add("show"),setTimeout(()=>{document.querySelector(".search-input").focus()},100)});const t=()=>{document.querySelector(".popup").classList.remove("show")};document.querySelector(".popup-btn-close").addEventListener("click",()=>{t()}),window.addEventListener("keyup",e=>{"Escape"===e.key&&t()})})</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Search or jump to..."></div><div id="local-search-result"></div></div></div><script src="https://cdn.jsdelivr.net/npm/hexo-widget-tree@0.1.1/js/index.js"></script><div id="widget-tree"><ul><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/Java/">Java</a><ul class="tree-list-children"><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/Java/JVM/">JVM</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/d4cbe240/" title="Java对象引用的细化"><i class="post-icon gg-file-document"></i>Java对象引用的细化</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/Java/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/fa978b73/" title="HotSpot对synchronized的锁优化策略"><i class="post-icon gg-file-document"></i>HotSpot对synchronized的锁优化策略</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/cf2f473d/" title="Java中保证线程安全的三板斧"><i class="post-icon gg-file-document"></i>Java中保证线程安全的三板斧</a></li><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/369cb3ec/" title="深入剖析volatile关键字"><i class="post-icon gg-file-document"></i>深入剖析volatile关键字</a></li></ul></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/MyBlogs%E7%B3%BB%E5%88%97/">MyBlogs系列</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/e0afdf66/" title="从零开始搭建一个属于自己的小站"><i class="post-icon gg-file-document"></i>从零开始搭建一个属于自己的小站</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/Reprint/">Reprint</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/d78266f6/" title="9个主流的开源许可协议"><i class="post-icon gg-file-document"></i>9个主流的开源许可协议</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/Spring/">Spring</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/78dbede3/" title="快速搭建一个简易的SpringBoot项目"><i class="post-icon gg-file-document"></i>快速搭建一个简易的SpringBoot项目</a></li></ul></li><li class="tree-list-item"><i class="toggle-post-icon gg-folder-add"></i><a class="tree-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a><ul class="tree-list-children"><li class="tree-list-item"><a class="tree-list-post-link" href="/posts/d9c27918/" title="HTTP协议之状态码"><i class="post-icon gg-file-document"></i>HTTP协议之状态码</a></li></ul></li></ul><div id="widget-tree-button"><i class="gg-chevron-right"></i></div></div><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script><script data-pjax>function GithubCalendarConfig(){var e=document.getElementById("calendar-main-inner");e&&"/about/"==location.pathname&&(console.log("已挂载github calendar"),e.insertAdjacentHTML("afterbegin",'<div class="post-block animated fadeIn" style="width:100%;height:auto;padding:40px 10px 10px 10px;"><div id="github_loading" style="height:100%;display: flex;align-items: center;justify-content: center;"><svg style="height:50px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div><footer class="post-footer"><div class="post-eof"></div></footer>')),GithubCalendar("https://python-github-calendar-api.vercel.app/api?Horizon-x",["#ebedf0","#f1f8ff","#dbedff","#c8e1ff","#79b8ff","#2188ff","#0366d6","#005cc5","#044289","#032f62","#05264c"],"Horizon-x")}document.getElementById("calendar-main-inner")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:0}}</style><style></style><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},react:{opacity:.7},log:!1})</script><script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'BN_dQoGLHrUXi0sHhuNwHGJlh9VryLBiBmPZ_dpECgQzkdUCH_kZA7-PYzh7LUIpFM9A9HIoh-kwANh97KlaL-o' });</script></body></html>